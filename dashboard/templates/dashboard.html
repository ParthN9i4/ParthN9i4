{% extends "base.html" %}
{% block title %}Dashboard â€” PPML/FHE{% endblock %}
{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>
    <p class="text-gray-500 text-sm">{{ today.strftime('%A, %B %d, %Y') }}</p>
</div>

<!-- Stats Row -->
<div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-indigo-500">
        <p class="text-xs text-gray-500 uppercase tracking-wider">Total Events</p>
        <p class="text-2xl font-bold text-gray-800">{{ total_events }}</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-blue-500">
        <p class="text-xs text-gray-500 uppercase tracking-wider">Conferences</p>
        <p class="text-2xl font-bold text-gray-800">{{ total_conferences }}</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-green-500">
        <p class="text-xs text-gray-500 uppercase tracking-wider">Journals</p>
        <p class="text-2xl font-bold text-gray-800">{{ total_journals }}</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-purple-500">
        <p class="text-xs text-gray-500 uppercase tracking-wider">Workshops</p>
        <p class="text-2xl font-bold text-gray-800">{{ total_workshops }}</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 {% if overdue_todos > 0 %}border-red-500{% else %}border-gray-300{% endif %}">
        <p class="text-xs text-gray-500 uppercase tracking-wider">Overdue Tasks</p>
        <p class="text-2xl font-bold {% if overdue_todos > 0 %}text-red-600{% else %}text-gray-800{% endif %}">{{ overdue_todos }}</p>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Upcoming Deadlines -->
    <div class="lg:col-span-2 bg-white rounded-xl shadow-sm">
        <div class="p-4 border-b border-gray-100 flex items-center justify-between">
            <h2 class="font-semibold text-gray-800">Upcoming Deadlines</h2>
            <a href="{{ url_for('events', sort='deadline') }}" class="text-sm text-indigo-600 hover:underline">View all</a>
        </div>
        <div class="divide-y divide-gray-50">
            {% for event in upcoming_deadlines %}
            <div class="p-4 hover:bg-gray-50 transition">
                <div class="flex items-start justify-between">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full
                                {% if event.category == 'conference' %}bg-blue-100 text-blue-700
                                {% elif event.category == 'journal' %}bg-green-100 text-green-700
                                {% elif event.category == 'workshop' %}bg-purple-100 text-purple-700
                                {% elif event.category == 'call_for_chapters' %}bg-pink-100 text-pink-700
                                {% else %}bg-gray-100 text-gray-700{% endif %}">
                                {{ event.category }}
                            </span>
                            {% if event.location %}
                            <span class="text-xs text-gray-400">{{ event.location }}</span>
                            {% endif %}
                        </div>
                        <h3 class="font-medium text-gray-800 truncate">
                            {% if event.website %}<a href="{{ event.website }}" target="_blank" class="hover:text-indigo-600">{{ event.title }}</a>
                            {% else %}{{ event.title }}{% endif %}
                        </h3>
                        {% if event.relevance_tags %}
                        <p class="text-xs text-gray-400 mt-1">{{ event.relevance_tags }}</p>
                        {% endif %}
                    </div>
                    <div class="ml-4 text-right flex-shrink-0">
                        {% set days = event.days_until_deadline %}
                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold
                            {% if days <= 3 %}bg-red-100 text-red-700
                            {% elif days <= 7 %}bg-amber-100 text-amber-700
                            {% elif days <= 14 %}bg-yellow-100 text-yellow-700
                            {% else %}bg-green-100 text-green-700{% endif %}">
                            {% if days == 0 %}TODAY
                            {% elif days == 1 %}1 day
                            {% else %}{{ days }} days{% endif %}
                        </span>
                        <p class="text-xs text-gray-400 mt-1">{{ event.submission_deadline.strftime('%b %d, %Y') }}</p>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="p-8 text-center text-gray-400">No upcoming deadlines in the next 60 days.</div>
            {% endfor %}
        </div>
    </div>

    <!-- Right Column -->
    <div class="space-y-6">
        <!-- Pending Tasks -->
        <div class="bg-white rounded-xl shadow-sm">
            <div class="p-4 border-b border-gray-100 flex items-center justify-between">
                <h2 class="font-semibold text-gray-800">Tasks</h2>
                <a href="{{ url_for('todos') }}" class="text-sm text-indigo-600 hover:underline">View all</a>
            </div>
            <div class="p-4 space-y-2">
                {% for todo in pending_todos %}
                <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50">
                    <form method="POST" action="{{ url_for('todo_update', tid=todo.id) }}">
                        <input type="hidden" name="status" value="completed">
                        <button type="submit" class="w-5 h-5 rounded border-2 flex-shrink-0 hover:bg-indigo-50
                            {% if todo.priority == 'high' %}border-red-400
                            {% elif todo.priority == 'medium' %}border-amber-400
                            {% else %}border-gray-300{% endif %}"></button>
                    </form>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm text-gray-700 truncate">{{ todo.title }}</p>
                        {% if todo.due_date %}
                        <p class="text-xs {% if todo.is_overdue %}text-red-500{% else %}text-gray-400{% endif %}">
                            {% if todo.is_overdue %}Overdue: {% endif %}{{ todo.due_date.strftime('%b %d') }}
                        </p>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <p class="text-sm text-gray-400 text-center py-4">No pending tasks.</p>
                {% endfor %}
            </div>
        </div>

        <!-- CFP Open -->
        {% if cfp_open %}
        <div class="bg-white rounded-xl shadow-sm">
            <div class="p-4 border-b border-gray-100">
                <h2 class="font-semibold text-gray-800">Open CFPs</h2>
            </div>
            <div class="p-4 space-y-2">
                {% for event in cfp_open[:8] %}
                <div class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-50">
                    <div class="min-w-0 flex-1">
                        <p class="text-sm font-medium text-gray-700 truncate">
                            {% if event.website %}<a href="{{ event.website }}" target="_blank" class="hover:text-indigo-600">{{ event.title }}</a>
                            {% else %}{{ event.title }}{% endif %}
                        </p>
                    </div>
                    <span class="ml-2 px-2 py-0.5 text-xs bg-green-100 text-green-700 rounded-full flex-shrink-0">Open</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- PhD Milestones -->
        {% if milestones %}
        <div class="bg-white rounded-xl shadow-sm">
            <div class="p-4 border-b border-gray-100 flex items-center justify-between">
                <h2 class="font-semibold text-gray-800">PhD Milestones</h2>
                <a href="{{ url_for('timeline') }}" class="text-sm text-indigo-600 hover:underline">View all</a>
            </div>
            <div class="p-4 space-y-2">
                {% for m in milestones %}
                <div class="flex items-center gap-3 p-2">
                    <div class="w-2 h-2 rounded-full flex-shrink-0
                        {% if m.status == 'in_progress' %}bg-amber-400
                        {% elif m.status == 'delayed' %}bg-red-400
                        {% else %}bg-gray-300{% endif %}"></div>
                    <div class="flex-1">
                        <p class="text-sm text-gray-700">{{ m.title }}</p>
                        {% if m.target_date %}
                        <p class="text-xs text-gray-400">Target: {{ m.target_date.strftime('%b %Y') }}</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Quick Daily Log -->
        <div class="bg-white rounded-xl shadow-sm">
            <div class="p-4 border-b border-gray-100 flex items-center justify-between">
                <h2 class="font-semibold text-gray-800">Today's Log</h2>
                <a href="{{ url_for('daily_log') }}" class="text-sm text-indigo-600 hover:underline">Full log</a>
            </div>
            <div class="p-4">
                {% if today_log and today_log.content %}
                <p class="text-sm text-gray-600">{{ today_log.content[:200] }}{% if today_log.content|length > 200 %}...{% endif %}</p>
                {% if today_log.hours_worked %}<p class="text-xs text-gray-400 mt-2">{{ today_log.hours_worked }}h logged</p>{% endif %}
                {% else %}
                <form method="POST" action="{{ url_for('daily_log_save') }}">
                    <input type="hidden" name="log_date" value="{{ today.isoformat() }}">
                    <textarea name="content" rows="3" placeholder="What did you work on today?"
                              class="w-full text-sm border border-gray-200 rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    <div class="flex items-center gap-2 mt-2">
                        <input type="number" name="hours_worked" step="0.5" min="0" max="24" placeholder="Hours"
                               class="w-20 text-sm border border-gray-200 rounded-lg p-1.5">
                        <button type="submit" class="px-3 py-1.5 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700">Save</button>
                    </div>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Deadline Timeline Chart -->
<div class="mt-6 bg-white rounded-xl shadow-sm p-6">
    <h2 class="font-semibold text-gray-800 mb-4">Deadline Timeline (Next 90 Days)</h2>
    <canvas id="deadlineChart" height="80"></canvas>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const deadlines = {{ upcoming_deadlines | map(attribute='to_dict') | list | tojson }};
    if (deadlines.length > 0 && document.getElementById('deadlineChart')) {
        const ctx = document.getElementById('deadlineChart').getContext('2d');
        const colors = {
            'conference': '#3b82f6',
            'journal': '#10b981',
            'workshop': '#8b5cf6',
            'seminar': '#f59e0b',
            'school': '#ef4444',
            'call_for_chapters': '#ec4899'
        };
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: deadlines.map(d => d.title.substring(0, 30)),
                datasets: [{
                    label: 'Days until deadline',
                    data: deadlines.map(d => d.days_until_deadline),
                    backgroundColor: deadlines.map(d => {
                        if (d.days_until_deadline <= 7) return '#ef4444';
                        if (d.days_until_deadline <= 14) return '#f59e0b';
                        return colors[d.category] || '#6b7280';
                    }),
                    borderRadius: 4,
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { title: { display: true, text: 'Days Remaining' } },
                    y: { ticks: { font: { size: 11 } } }
                }
            }
        });
    }
});
</script>
{% endblock %}
